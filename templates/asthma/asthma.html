{% extends "common.html" %}
{% block content %}
<style>
html {
    height: 100%;
    overflow-x: hidden;
}

body {
    margin: 0;
    padding: 0;
    min-height: 100%;
    overflow-x: hidden;
    position: relative;
    -webkit-overflow-scrolling: touch;
}

.asthma-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 10px 15px 20px 15px;
    background: #f8f9fa;
    max-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
    position: relative;
    box-sizing: border-box;
}

.top-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2px 0;
    border-bottom: 2px solid #e9ecef;
}

.title-section {
    display: flex;
    align-items: center;
    gap: 15px;
}

.title-section h2 {
    margin: 0;
    color: #e74c3c;
    font-size: 1.6em;
}

@media (max-width: 300px) {
    .title-section h2 {
        font-size: .7m;
    }
    
    .top-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
    
    .date-selector {
        align-self: flex-end;
    }
}

.date-selector {
    background: white;
    border-radius: 6px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 1px solid #dee2e6;
}

.date-selector input {
    width: 120px;
    font-size: 14px;
    padding: 8px;
}

.prediction-widgets {
    display: flex;
    width: 100%;
    justify-content: space-between;
    margin: 15px 0;
}

.prediction-widget {
    width: 45%;
    background: white;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    text-align: center;
    transition: transform 0.2s;
    box-sizing: border-box;
}

.prediction-widget:hover {
    transform: translateY(-2px);
}

.prediction-label {
    font-size: clamp(11px, 2.5vw, 14px);
    color: #666;
    margin-bottom: 8px;
    font-weight: 500;
    line-height: 1.2;
}

.prediction-value {
    font-size: clamp(16px, 4vw, 24px);
    font-weight: bold;
    margin-bottom: 5px;
    line-height: 1.1;
}

@media (max-width: 400px) {
    .prediction-widgets {
        justify-content: space-between;
    }
    
    .prediction-widget {
        width: 45%;
        padding: 12px;
        box-sizing: border-box;
    }
    
    .prediction-label {
        font-size: clamp(10px, 3vw, 12px);
        line-height: 1.1;
    }
    
    .prediction-value {
        font-size: clamp(14px, 5vw, 20px);
        line-height: 1;
    }
    
    .prediction-subtitle {
        font-size: clamp(8px, 2vw, 10px);
        line-height: 1.1;
    }
}

.recommendation-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    max-width: 1000px;
}

.prediction-box {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    text-align: center;
    min-width: 160px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.prediction-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.prediction-box.high-risk {
    border-color: #dc3545;
    background: #fff5f5;
}

.prediction-box.medium-risk {
    border-color: #ffc107;
    background: #fffbf0;
}

.prediction-box.low-risk {
    border-color: #28a745;
    background: #f8fff8;
    width: 49%
}

.prediction-box.good-env {
    border-color: #17a2b8;
    background: #f0fdff;
    width: 49%;
}

.prediction-box.bad-env {
    border-color: #fd7e14;
    background: #fff8f0;
}

.prediction-box.severe-env {
    border-color: #dc3545;
    background: #fff5f5;
}

.prediction-box.recommendation {
    border-color: #6f42c1;
    background: #f8f7ff;
    text-align: left;
    min-height: 80px;
    width: 100%;
}

.input-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #e9ecef;
}

.input-container1::after {
    content: "";
    display: table;
    clear: both;
}

.pef-input-section {
    margin: 0px 0;
}

.pef-line {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.pef-title-row {
    display: flex;
    align-items: center;
    gap: 15px;
}

.pef-slider-row {
    display: flex;
    align-items: center;
    width: 100%;
}

.pef-title {
    color: #2c3e50;
    margin: 0;
    font-size: 1.4em;
    font-weight: bold;
    min-width: 60px;
}

.pef-value-display {
    font-size: 32px;
    font-weight: bold;
    text-align: center;
    padding: 3px 10px;
    border-radius: 8px;
    min-width: 120px;
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid #dee2e6;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.pef-status-text {
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    margin-top: 8px;
    padding: 4px 12px;
    border-radius: 20px;
    transition: all 0.3s ease;
}

/* Color coding for PEF values */
.pef-critical {
    color: #dc3545;
    border-color: #dc3545;
    background: #fff5f5;
}

.pef-poor {
    color: #fd7e14;
    border-color: #fd7e14;
    background: #fff8f0;
}

.pef-fair {
    color: #ffc107;
    border-color: #ffc107;
    background: #fffbf0;
}

.pef-good {
    color: #28a745;
    border-color: #28a745;
    background: #f8fff8;
}

.pef-excellent {
    color: #20c997;
    border-color: #20c997;
    background: #f0fff4;
}

.pef-slider {
    width: 100%;
    height: 18px;
    border-radius: 9px;
    background: linear-gradient(to right, #e74c3c 0%, #f39c12 50%, #27ae60 100%);
    outline: none;
    opacity: 0.9;
    transition: opacity 0.2s;
    margin: 15px 0;
    cursor: pointer;
}

.pef-slider:hover {
    opacity: 1;
}

.pef-slider::-webkit-slider-thumb {
    appearance: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #2c3e50;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    border: 3px solid white;
}

.pef-slider::-moz-range-thumb {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #2c3e50;
    cursor: pointer;
    border: 3px solid white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
}

.pef-slider::-webkit-slider-track {
    height: 18px;
    border-radius: 9px;
}

.pef-slider::-moz-range-track {
    height: 18px;
    border-radius: 9px;
    border: none;
}

@media (max-width: 500px) {
    .pef-line {
        align-items: flex-start;
        gap: 1px;
    }
    
    .pef-title-row {
        align-items: center;
        gap: 8px;
    }
    
    .pef-value-display {
        font-size: 28px;
        min-width: 100px;
        padding: 2px 2px;
    }
    
    .pef-status-text {
        font-size: 12px;
        margin-top: 4px;
    }
    
    .pef-slider {
        width: 100%;
        min-width: unset;
    }
}

.detail-boxes {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 2px;
    width: 100%;
}

.detail-box {
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #e9ecef;
    width: 100%;
}

.detail-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-color: #e74c3c;
}

.detail-box.active {
    border-color: #e74c3c;
    background: #fff5f5;
}

.detail-box h4 {
    margin: 0 0 10px 0;
    color: #495057;
    font-size: 16px;
}

.detail-box p {
    margin: 0;
    color: #666;
    font-size: 14px;
}

.hidden-form {
    display: none;
    background: white;
    padding: 6px;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    margin: 20px 0;
    border: 2px solid #e74c3c;
    position: absolute;
    bottom: 20;
    left: 0;
    right: 0;
    margin-bottom: 10px;
    animation: slideUp 0.3s ease-out;
    z-index: 10;
}

.detail-boxes {
    position: relative;
}

.hidden-form.show {
    display: block;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}



.button-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 10px 0;
}

.btn-toggle {
    padding: 8px 16px;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
    color: #495057;
}

.btn-toggle:hover {
    border-color: #e74c3c;
    background: #f8f9fa;
}

.btn-toggle.active {
    background: #e74c3c;
    color: white;
    border-color: #e74c3c;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.close-btn {
    background: #dc3545;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    float: right;
    margin-bottom: 15px;
}

.notes-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.recommendation-text {
    font-size: 14px;
    line-height: 1.5;
    color: #495057;
    margin-top: 8px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.prediction-title {
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
    font-weight: 600;
}

.prediction-value {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 5px;
}

.prediction-subtitle {
    font-size: 12px;
    color: #888;
}

.asthma-form {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.1);
}

.form-section {
    margin-bottom: 15px;
    padding: 20px;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    background: #fafafa;
}

.form-section h4 {
    color: #495057;
    margin-bottom: 15px;
    border-bottom: 2px solid #e74c3c;
    padding-bottom: 5px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
    display: block;
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.form-control:focus {
    border-color: #e74c3c;
    box-shadow: 0 0 0 0.2rem rgba(231, 76, 60, 0.25);
    outline: none;
}

.btn-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.btn-option {
    padding: 15px;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 14px;
    text-align: center;
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
}

.btn-option:hover {
    border-color: #e74c3c;
    background: #ffeaa7;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.btn-option.active {
    background: #e74c3c;
    color: white;
    border-color: #e74c3c;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
}

.input-container {
    background: white;
    padding: 10 10 0 10;
    border-radius: 8px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    margin: 10px 0;
}

.submit-btn {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 12px rgba(0, 123, 255, 0.3);
    display: block;
    margin: 20px auto;
    min-width: 150px;
    text-align: center;
}

.submit-btn:hover {
    background: linear-gradient(135deg, #0056b3, #004085);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
}

.inhaler-image {
    text-align: center;
    margin: 20px 0;
}

.inhaler-image img {
    max-width: 150px;
    height: auto;
    border-radius: 8px;
}

.status-message {
    padding: 15px;
    border-radius: 6px;
    margin: 20px 0;
    display: none;
}

.status-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.status-error {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.patient-info {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
}

.symptoms-section {
    background: #fff3e0;
    border-left: 4px solid #ff9800;
}

.environment-section {
    background: #f3e5f5;
    border-left: 4px solid #9c27b0;
}

.medication-section {
    background: #e8f5e8;
    border-left: 4px solid #4caf50;
}

.multimedia-notes-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 0px;
    padding: 10px;
}

.notes-container {
    position: relative;
}

.media-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 2px;
    justify-content: flex-end;
}

.media-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid #e74c3c;
    background: white;
    color: #e74c3c;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.media-btn:hover {
    background: #e74c3c;
    color: white;
    transform: scale(1.1);
}

.media-btn.recording {
    background: #e74c3c;
    color: white;
    animation: pulse 1s infinite;
}

.media-btn-signin {
    border: 2px solid green;
    background: green;
    color: white    ;
}
.bottom-media-section {
    position: fixed;
    bottom: 0;
    bottom: env(safe-area-inset-bottom);
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid #e9ecef;
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 15px;
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    z-index: 10;
}

.bottom-media-section .media-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
}

.submit-media-btn {
    background: linear-gradient(135deg, #007bff, #0056b3) !important;
    color: white !important;
    border: 2px solid #007bff !important;
    box-shadow: 0 3px 12px rgba(0, 123, 255, 0.3) !important;
}

.submit-media-btn:hover {
    background: linear-gradient(135deg, #0056b3, #004085) !important;
    color: white !important;
    transform: scale(1.15) !important;
    box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4) !important;
}

@media (max-width: 768px) {
    .bottom-media-section {
        padding: 8px 10px;
        gap: 10px;
    }
    
    .bottom-media-section .media-buttons {
        gap: 8px;
    }
}

.notes-content {
    position: relative;
}

.media-preview {
    margin-top: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.media-item {
    position: relative;
    max-width: 29%;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: inline-block;
    margin: 2px;
}

.media-item img {
    width: 100%;
    height: auto;
    display: block;
}

.media-item audio {
    width: 100%;
}

.media-remove {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(231, 76, 60, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.recording-indicator {
    background: rgba(231, 76, 60, 0.1);
    border: 1px solid #e74c3c;
    border-radius: 6px;
    padding: 8px 12px;
    margin-top: 10px;
    font-size: 14px;
    color: #e74c3c;
    display: flex;
    align-items: center;
    gap: 8px;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
</style>

<div class="asthma-container">
    <!-- Top Header with Title and Date -->
    <div class="top-header">
        <div class="title-section">
            <i class="fa fa-lungs" style="font-size: 1.3em; color: #e74c3c;"></i>
            <h2 style="font-size: 1.3em;">Asthma Manager</h2>
        </div>
        <div class="date-selector">
            <input type="date" class="form-control" id="date" name="date" required>
        </div>
    </div>

    <!-- Prediction Widgets -->
    <div class="prediction-widgets">
        <div class="prediction-box low-risk" id="riskPrediction">
            <div class="prediction-title">Risk Level</div>
            <div class="prediction-value" style="color: #28a745;">LOW</div>
        </div>
        <div class="prediction-box good-env" id="environmentPrediction">
            <div class="prediction-title">Environment Score</div>
            <div class="prediction-value" style="color: #17a2b8;">GOOD</div>
        </div>
    </div>
    
    <!-- Recommendation Widget (Full Width) -->
    <div class="recommendation-container">
        <div class="prediction-box recommendation" id="recommendationPrediction">
            <div class="prediction-title">Advice for Activity</div>
            <div class="recommendation-text" id="recommendationText">Enter PEF value for personalized activity advice</div>
        </div>
    </div>

    <!-- Input Container -->
    <form class="asthma-form" id="asthmaForm">
        <div class="input-container">
        
        <!-- PEF Input Section -->
        <div class="pef-input-section">
        <div class="pef-line">
            <div class="pef-title-row">
                <h3 class="pef-title">PEFR</h3>
                <div class="pef-value-display" id="pefValueDisplay">400</div>
            <div class="pef-status-text" id="pefStatusText">Normal Range</div>
        </div>
        <div class="pef-slider-row">
                <input type="range" class="pef-slider" id="pefSlider" min="100" max="900" value="400" oninput="updatePEFFromSlider(this.value)">
            </div>
        </div>
        <input type="hidden" id="pefInput" name="pef" value="400">
    </div>

    <!-- Detail Selection Boxes -->
    <div class="detail-boxes">
        {% include 'asthma/symptom_inc.html' %}
        {% include 'asthma/med_inc.html' %}
        <div class="detail-box" onclick="toggleForm('symptomsForm', this)">
            <h4><i class="fa fa-heartbeat"></i> Symptoms</h4>
            <p>Click to add</p>

        </div>
        <div class="detail-box" onclick="toggleForm('medicationForm', this)">
            <h4><i class="fa fa-pills"></i> Medication</h4>
            <p>Click to add</p>
        </div>
    </div>

        <!-- Hidden patient ID field -->
        <input type="hidden" id="user_id" name="user_id" value="{{user.username}}">
        <input type="hidden" id="pefInput" name="pef" value="400">

        <!-- Multimedia Notes Section -->
        <div class="notes-container">
            <div class="notes-content">
                <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Type additional notes, symptoms, or concerns for your doctor..."></textarea>
                
                <!-- Hidden file inputs -->
                <input type="file" id="imageUpload" accept="image/*,video/*" multiple style="display: none;" onchange="handleImageUpload(event)">
                <input type="file" id="cameraCapture" accept="image/*" capture="camera" style="display: none;" onchange="handleImageUpload(event)">
                
                <!-- Media preview area -->
                <div class="media-preview" id="mediaPreview"></div>
                
                <!-- Audio recording indicator -->
                <div class="recording-indicator" id="recordingIndicator" style="display: none;">
                    <i class="fa fa-circle" style="color: red; animation: blink 1s infinite;"></i>
                    Recording... <span id="recordingTime">00:00</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Media Buttons at Bottom -->
    <div class="bottom-media-section">
        <div class="media-buttons">
            <button type="button" class="media-btn" id="recordAudioBtn" onclick="toggleAudioRecording()" title="Record Audio">
                <i class="fa fa-microphone"></i>
            </button>
            <button type="button" class="media-btn" onclick="document.getElementById('imageUpload').click()" title="Upload Image">
                <i class="fa fa-image"></i>
            </button>
            <button type="button" class="media-btn" id="cameraBtn" onclick="openCamera()" title="Take Photo">
                <i class="fa fa-camera"></i>
            </button>
        
        <button type="submit" class="media-btn submit-media-btn" title="Submit Assessment">
            <i class="fa fa-upload"></i>
        </button>

        {% if not user.is_authenticated %}
            <a class="media-btn media-btn-signin" href="{% url 'account_login' %}"><i class="fas fa-sign-in-alt"></i><span class="our_menu"> Sign in</span></a>
        
        {% else  %}
                <ul class="navbar-nav  mr-auto">
                <li class="nav-item dropdown">
                <a class="nav-item nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" >
                    <span class="our_menu">Me</span></a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-versions" style="z-index:2;">
                <a class="dropdown-item" href="#">{{ user.email }}</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="{% url 'account_logout' %}"><i class="fas fa-sign-out-alt"></i>Sign Out</a>
                </div>
                </li>
                </ul>
        {% endif %}



    </div>
    </div>
    </form>

    <div id="statusMessage" class="status-message"></div>
</div>

<script>
let USER_ID='{{user.username}}'    

// Update PEF from slider
function updatePEFFromSlider(value) {
    const numValue = parseInt(value);
    
    // Update display elements
    document.getElementById('pefValueDisplay').textContent = numValue;
    document.getElementById('pefInput').value = numValue;
    
    // Update color coding and status text
    updatePEFColorCoding(numValue);
    
    // Note: Risk level and activity advice are predicted by AI, not automatically calculated
}

// Update PEF color coding based on value
function updatePEFColorCoding(value) {
    const display = document.getElementById('pefValueDisplay');
    const statusText = document.getElementById('pefStatusText');
    
    // Remove all existing classes
    display.classList.remove('pef-critical', 'pef-poor', 'pef-fair', 'pef-good', 'pef-excellent');
    statusText.classList.remove('pef-critical', 'pef-poor', 'pef-fair', 'pef-good', 'pef-excellent');
    
    // Apply color coding based on PEF ranges
    if (value < 200) {
        display.classList.add('pef-critical');
        statusText.classList.add('pef-critical');
        statusText.textContent = 'Critical - Seek medical attention';
    } else if (value < 300) {
        display.classList.add('pef-poor');
        statusText.classList.add('pef-poor');
        statusText.textContent = 'Poor - Avoid physical activity';
    } else if (value < 500) {
        display.classList.add('pef-fair');
        statusText.classList.add('pef-fair');
        statusText.textContent = 'Fair - Light activity only';
    } else if (value < 600) {
        display.classList.add('pef-good');
        statusText.classList.add('pef-good');
        statusText.textContent = 'Good - Normal activities OK';
    } else {
        display.classList.add('pef-excellent');
        statusText.classList.add('pef-excellent');
        statusText.textContent = 'Excellent - All activities safe';
    }
}

// Initialize PEF display on page load
function initializePEF() {
    const initialValue = document.getElementById('pefSlider').value;
    updatePEFFromSlider(initialValue);
}

// Toggle form visibility
function toggleForm(formId, boxElement) {
    const form = document.getElementById(formId);
    const isVisible = form.classList.contains('show');
    
    // Close all forms first
    document.querySelectorAll('.hidden-form').forEach(f => {
        f.classList.remove('show');
    });
    document.querySelectorAll('.detail-box').forEach(box => {
        //box.classList.remove('active');
    });
    
    // If form wasn't visible, show it
    if (!isVisible) {
        form.classList.add('show');
        boxElement.classList.add('active');
    }
}

// Close specific form
function closeForm(formId) {
    document.getElementById(formId).classList.remove('show');
    document.querySelectorAll('.detail-box').forEach(box => {
        box.classList.remove('active');
    });
}

// Toggle button selection
function toggleButton(button) {
    const groupName = button.getAttribute('data-name');
    
    // Remove active class from other buttons in the same group
    document.querySelectorAll(`[data-name="${groupName}"]`).forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to clicked button
    button.classList.add('active');
    
    // Update predictions
    updatePredictions();
}

// Handle form changes
document.addEventListener('change', function(e) {
    if (e.target.tagName === 'SELECT') {
        updatePredictions();
    }
});

// Function to calculate and update predictions
function updatePredictions() {
    let severityScore = 0;
    
    // Get PEF value
    const pefValue = parseInt(document.getElementById('pefSlider').value);
    
    // Get current form selections from selects and buttons
    const selections = {};
    
    // Get select values
    document.querySelectorAll('select').forEach(select => {
        if (select.value) {
            selections[select.name] = select.value;
        }
    });
    
    // Get button toggle values
    document.querySelectorAll('.btn-toggle.active').forEach(button => {
        const name = button.getAttribute('data-name');
        const value = button.getAttribute('data-value');
        selections[name] = value;
    });
    
    // Calculate severity score based on PEF
    if (pefValue < 200) severityScore += 4;
    else if (pefValue < 300) severityScore += 3;
    else if (pefValue < 400) severityScore += 2;
    else if (pefValue < 500) severityScore += 1;
    
    // Breathing difficulty scoring
    if (selections.breathing === 'severe') severityScore += 3;
    else if (selections.breathing === 'moderate') severityScore += 2;
    else if (selections.breathing === 'mild') severityScore += 1;
    
    // Wheezing scoring
    if (selections.wheezing === 'severe') severityScore += 3;
    else if (selections.wheezing === 'moderate') severityScore += 2;
    else if (selections.wheezing === 'mild') severityScore += 1;
    
    // Cough frequency scoring
    if (selections.cough === 'persistent') severityScore += 2;
    else if (selections.cough === 'frequent') severityScore += 1;
    
    // Inhaler usage scoring
    if (selections.inhalerUsage === '5+') severityScore += 3;
    else if (selections.inhalerUsage === '3-4') severityScore += 2;
    else if (selections.inhalerUsage === '1-2') severityScore += 1;
    
    // Medication effectiveness scoring
    if (selections.effectiveness === 'poor') severityScore += 2;
    else if (selections.effectiveness === 'fair') severityScore += 1;
    
    // Update severity score display (removed - no longer displayed)
    // document.querySelector('#severityPrediction .prediction-value').textContent = `${severityScore}/15`;
    
    // Determine risk level
    let riskLevel, riskColor, riskClass;
    if (severityScore >= 8) {
        riskLevel = 'HIGH';
        riskColor = '#dc3545';
        riskClass = 'high-risk';
    } else if (severityScore >= 4) {
        riskLevel = 'MEDIUM';
        riskColor = '#ffc107';
        riskClass = 'medium-risk';
    } else {
        riskLevel = 'LOW';
        riskColor = '#28a745';
        riskClass = 'low-risk';
    }
    
    // Update risk prediction display
    const riskBox = document.getElementById('riskPrediction');
    riskBox.className = `prediction-box ${riskClass}`;
    riskBox.querySelector('.prediction-value').textContent = riskLevel;
    riskBox.querySelector('.prediction-value').style.color = riskColor;
    
    // Severity score removed - no longer displayed
    
    // Calculate environment score
    let envScore = 0;
    let envLevel, envColor, envClass;
    
    // Environment factors
    if (selections.environment === 'outdoor') envScore += 1;
    else if (selections.environment === 'exercise') envScore += 2;
    
    // Trigger exposure scoring
    if (selections.triggers === 'smoke') envScore += 3;
    else if (selections.triggers === 'pollen' || selections.triggers === 'dust') envScore += 2;
    else if (selections.triggers === 'pets' || selections.triggers === 'weather') envScore += 1;
    
    // Determine environment level
    if (envScore >= 4) {
        envLevel = 'SEVERE';
        envColor = '#dc3545';
        envClass = 'severe-env';
    } else if (envScore >= 2) {
        envLevel = 'BAD';
        envColor = '#fd7e14';
        envClass = 'bad-env';
    } else {
        envLevel = 'GOOD';
        envColor = '#17a2b8';
        envClass = 'good-env';
    }
    
    // Update environment prediction display
    const envBox = document.getElementById('environmentPrediction');
    envBox.className = `prediction-box ${envClass}`;
    envBox.querySelector('.prediction-value').textContent = envLevel;
    envBox.querySelector('.prediction-value').style.color = envColor;
    
    // Generate activity advice based on PEF and symptoms
    let activityAdvice = [];
    
    // PEF-based activity recommendations
    if (pefValue >= 600) {
        activityAdvice.push('🏃‍♂️ Normal activities and exercise are safe');
        activityAdvice.push('🌟 Peak performance zone - all activities recommended');
    } else if (pefValue >= 400) {
        activityAdvice.push('🚶‍♂️ Light to moderate activities are safe');
        activityAdvice.push('⚠️ Avoid intense exercise, monitor symptoms');
    } else if (pefValue >= 250) {
        activityAdvice.push('🏠 Indoor activities only, avoid exertion');
        activityAdvice.push('🚨 Take rescue medication before any activity');
    } else {
        activityAdvice.push('🛑 Rest and avoid all physical activities');
        activityAdvice.push('🚨 Seek immediate medical attention');
    }
    
    // Environmental adjustments
    if (envScore >= 3) {
        activityAdvice = ['🏠 Stay indoors due to poor air quality', '😷 Use air purifier if available'];
    } else if (envScore >= 2) {
        activityAdvice[1] = '😷 Wear mask for outdoor activities';
    }
    
    // Symptom-based modifications
    if (selections.breathing === 'severe' || selections.wheezing === 'severe') {
        activityAdvice = ['🛑 Complete rest recommended', '📞 Contact healthcare provider immediately'];
    }
    
    // Update recommendation display
    const recommendationText = document.getElementById('recommendationText');
    if (activityAdvice.length > 0) {
        recommendationText.innerHTML = activityAdvice.slice(0, 2).join('<br>');
    } else {
        recommendationText.textContent = 'Enter PEF value for personalized activity advice';
    }
}

// Set today's date as default
document.getElementById('date').valueAsDate = new Date();

// Multimedia Notes Functionality
let mediaRecorder;
let audioChunks = [];
let recordingTimer;
let recordingStartTime;

// Audio Recording Functions
async function toggleAudioRecording() {
    const recordBtn = document.getElementById('recordAudioBtn');
    const indicator = document.getElementById('recordingIndicator');
    
    console.log('Toggle audio recording called');
    
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        console.log('Stopping recording');
        // Stop recording
        mediaRecorder.stop();
        recordBtn.classList.remove('recording');
        recordBtn.style.background = 'white';
        recordBtn.style.color = '#e74c3c';
        indicator.style.display = 'none';
        clearInterval(recordingTimer);
    } else {
        console.log('Starting recording');
        // Start recording
        try {
            // Check if browser supports MediaRecorder
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('MediaRecorder not supported');
            }
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100
                }
            });
            
            console.log('Got audio stream');
            
            // Check MediaRecorder support with different MIME types
            let options = {};
            if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                options = { mimeType: 'audio/webm;codecs=opus' };
            } else if (MediaRecorder.isTypeSupported('audio/webm')) {
                options = { mimeType: 'audio/webm' };
            } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                options = { mimeType: 'audio/mp4' };
            }
            
            mediaRecorder = new MediaRecorder(stream, options);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = (event) => {
                console.log('Audio data available:', event.data.size);
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = () => {
                console.log('Recording stopped, chunks:', audioChunks.length);
                if (audioChunks.length > 0) {
                    const mimeType = mediaRecorder.mimeType || 'audio/webm';
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    console.log('Created audio blob:', audioBlob.size, 'bytes');
                    addAudioToPreview(audioBlob, mimeType);
                } else {
                    console.log('No audio data recorded');
                    alert('No audio was recorded. Please try again.');
                }
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.onerror = (event) => {
                console.error('MediaRecorder error:', event.error);
                alert('Recording error: ' + event.error);
            };
            
            mediaRecorder.start(1000); // Collect data every second
            console.log('Recording started');
            
            recordBtn.classList.add('recording');
            recordBtn.style.background = '#e74c3c';
            recordBtn.style.color = 'white';
            indicator.style.display = 'flex';
            recordingStartTime = Date.now();
            
            recordingTimer = setInterval(updateRecordingTime, 1000);
            
        } catch (error) {
            console.error('Audio recording error:', error);
            alert('Microphone access denied or not available: ' + error.message);
        }
    }
}

// Image Upload Functions
function handleImageUpload(event) {
    const files = event.target.files;
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                if (file.type.startsWith('image/')) {
                    addImageToPreview(e.target.result, file.name);
                } else if (file.type.startsWith('video/')) {
                    addVideoToPreview(e.target.result, file.name);
                }
            };
            reader.readAsDataURL(file);
        }
    }
    
    // Reset the input so the same file can be selected again
    event.target.value = '';
}

function openCamera() {
    // Try different approaches for mobile camera access
    const cameraInput = document.getElementById('cameraCapture');
    
    // For mobile devices, try to trigger camera directly
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // Try to use camera API directly for better mobile support
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment' // Use rear camera
            } 
        })
        .then(stream => {
            // Create a video element to capture the frame
            const video = document.createElement('video');
            video.srcObject = stream;
            video.play();
            
            // Create capture button overlay
            const captureDiv = document.createElement('div');
            captureDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: black;
                z-index: 10000;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            `;
            
            video.style.cssText = `
                width: 100%;
                height: 70%;
                object-fit: cover;
            `;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 20px;
                margin-top: 20px;
            `;
            
            const captureBtn = document.createElement('button');
            captureBtn.textContent = '📷 Capture';
            captureBtn.style.cssText = `
                padding: 15px 30px;
                background: #e74c3c;
                color: white;
                border: none;
                border-radius: 25px;
                font-size: 18px;
                cursor: pointer;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '✕ Close';
            closeBtn.style.cssText = `
                padding: 15px 30px;
                background: #666;
                color: white;
                border: none;
                border-radius: 25px;
                font-size: 18px;
                cursor: pointer;
            `;
            
            captureBtn.onclick = () => {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                canvas.toBlob(blob => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        addImageToPreview(e.target.result, 'camera-capture.jpg');
                    };
                    reader.readAsDataURL(blob);
                });
                
                stream.getTracks().forEach(track => track.stop());
                document.body.removeChild(captureDiv);
            };
            
            closeBtn.onclick = () => {
                stream.getTracks().forEach(track => track.stop());
                document.body.removeChild(captureDiv);
            };
            
            buttonContainer.appendChild(captureBtn);
            buttonContainer.appendChild(closeBtn);
            captureDiv.appendChild(video);
            captureDiv.appendChild(buttonContainer);
            document.body.appendChild(captureDiv);
        })
        .catch(error => {
            console.log('Camera API failed, falling back to file input:', error);
            // Fallback to file input with camera capture
            cameraInput.click();
        });
    } else {
        // Fallback for older browsers
        cameraInput.click();
    }
}

// Media Preview Functions
function addImageToPreview(src, filename) {
    const preview = document.getElementById('mediaPreview');
    const mediaItem = document.createElement('div');
    mediaItem.className = 'media-item';
    mediaItem.innerHTML = `
        <img src="${src}" alt="${filename}">
        <button type="button" class="media-remove" onclick="removeMediaItem(this)">×</button>
    `;
    preview.appendChild(mediaItem);
}

function addAudioToPreview(audioBlob, mimeType = 'audio/webm') {
    console.log('Adding audio to preview:', audioBlob.size, 'bytes, type:', mimeType);
    const preview = document.getElementById('mediaPreview');
    const audioUrl = URL.createObjectURL(audioBlob);
    const mediaItem = document.createElement('div');
    mediaItem.className = 'media-item';
    mediaItem.style.maxWidth = '250px';
    mediaItem.innerHTML = `
        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center;">
            <i class="fa fa-microphone" style="font-size: 24px; color: #e74c3c; margin-bottom: 10px;"></i>
            <audio controls style="width: 100%; margin-bottom: 5px;">
                <source src="${audioUrl}" type="${mimeType}">
                Your browser does not support audio playback.
            </audio>
            <small style="color: #666;">Audio Recording</small>
        </div>
        <button type="button" class="media-remove" onclick="removeMediaItem(this)">×</button>
    `;
    preview.appendChild(mediaItem);
    
    // Test if audio can be played
    const audio = mediaItem.querySelector('audio');
    audio.addEventListener('loadeddata', () => {
        console.log('Audio loaded successfully, duration:', audio.duration);
    });
    audio.addEventListener('error', (e) => {
        console.error('Audio loading error:', e);
    });
}

function addVideoToPreview(src, filename) {
    const preview = document.getElementById('mediaPreview');
    const mediaItem = document.createElement('div');
    mediaItem.className = 'media-item';
    mediaItem.style.maxWidth = '200px';
    mediaItem.innerHTML = `
        <video controls style="width: 100%; border-radius: 8px;">
            <source src="${src}" type="video/mp4">
            Your browser does not support video playback.
        </video>
        <button type="button" class="media-remove" onclick="removeMediaItem(this)">×</button>
    `;
    preview.appendChild(mediaItem);
}

function removeMediaItem(button) {
    const mediaItem = button.parentElement;
    const audio = mediaItem.querySelector('audio');
    if (audio) {
        URL.revokeObjectURL(audio.querySelector('source').src);
    }
    mediaItem.remove();
}
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function updateRecordCB(responseTxt, statusTxt, xhr, context, formData) {
    console.log('=== updateRecordCB callback called ===');
    console.log('Response:', responseTxt);
    console.log('Status:', statusTxt);
    console.log('XHR:', xhr);
    
    // Show a subtle notification instead of alert
    showUpdateNotification(responseTxt || 'Record updated');
}

function updateRecord() {
    let CUR_TIME=new Date().toISOString();
    console.log('=== updateRecord JavaScript function called ===');
    
    if (!USER_ID){
        console.log('ERROR: No USER_ID, showing notification');
        showUpdateNotification('Please login to update!');
        return;
    }
    
    let data={
        user_id:USER_ID,
        cur_time:CUR_TIME,
        pef:document.getElementById('pefInput').value,
        //breathing:document.getElementById('breathingInput').value,
        //cough:document.getElementById('coughInput').value,
        //wheezing:document.getElementById('wheezingInput').value,
        //environment:document.getElementById('environmentInput').value,
        //triggers:document.getElementById('triggersInput').value,
        //inhaler_usage:document.getElementById('inhalerUsageInput').value,
        //effectiveness:document.getElementById('effectivenessInput').value,
        //notes:document.getElementById('notesInput').value,
        //media:mediaChunks,
        //audio:audioChunks,
    }
    
    console.log('Sending data to /asthma/update/:', data);
    callws('/asthma/update/', "", updateRecordCB, data);
}
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Show a subtle update notification
function showUpdateNotification(txt, cls='btn-success') {
    // Remove any existing notification
    const existing = document.querySelector('.update-notification');
    if (existing) existing.remove();
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'update-notification';
    notification.classList.add('btn', cls);
    notification.textContent = txt;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    // Fade in
    setTimeout(() => notification.style.opacity = '1', 10);
    
    // Fade out and remove after 2 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

// Auto-update functionality - call updateRecord when any field changes
function setupAutoUpdate() {
    // Date input
    const dateInput = document.getElementById('date');
    if (dateInput) {
        dateInput.addEventListener('change', updateRecord);
    }
    
    // PEF slider
    const pefSlider = document.getElementById('pefSlider');
    if (pefSlider) {
        pefSlider.addEventListener('input', debounce(updateRecord, 500));
    }
    
    // Notes textarea
    const notesTextarea = document.getElementById('notes');
    if (notesTextarea) {
        notesTextarea.addEventListener('input', debounce(updateRecord, 1000));
    }
    
    // Hidden inputs for symptoms and medications will be handled by their respective selection functions
}

// Debounce function to prevent too many rapid calls
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

// Initialize PEF display and auto-update when page loads
window.addEventListener('load', function() {
    initializePEF();
    setupAutoUpdate();
});
</script>

{% endblock %}
